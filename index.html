<!DOCTYPE html>
<html>
	<head>
		<link rel='stylesheet' type='text/css' href='lib/css/main.css'/>
		<title>hockey eye</title>
		<script src="lib/gui.js"></script>
		<script src="lib/whammy.js"></script>

		<script>
			

			(function () {

            // webcam feed
				var videoElement,

            // videoElement is copied to canvas
						canvasElement    = document.createElement('canvas'),
            canvasElementCtx = canvasElement.getContext('2d'),
						
            requestAnimationFrameId;
						
            // TODO: replace with button, record/stop
            SET_TIMEOUT_RECORDING = 3000;

        console.log('Recording ' + SET_TIMEOUT_RECORDING + ' seconds.');

				// Always default to maximum resolution.  Seems like browsers are limited at 1920x1080 -- 2/21/15
				// http://stackoverflow.com/questions/27420581/get-maximum-video-resolution-with-getusermedia
				var MEDIA_SETTINGS = {
					'video': {
						'optional': [
						    {'minWidth': 640},
						    {'minWidth': 1024},
						    {'minWidth': 1280},
						    {'minWidth': 1920}, // 1080p is highest browsers can go (2/27)
						    {'minWidth': 2560},
						  ]
					},
					'audio': false
				};

				function onGetUserMediaError (err) {
          console.err(err);
				}

				function setCanvasSize (width, height) {
					canvasElement.height = height;
					canvasElement.width  = width;
				}


				function captureMedia (mediaStream) {
					
					window.stream = mediaStream;
					
					videoElement.src = window.URL.createObjectURL(mediaStream);

					videoElement.addEventListener('canplay', recordCam);

				}
					
				
				function recordCam () {	

          var firstFrameSent     = false,
              firstFrameTimestamp,
            // contains uint8ClampedArrays
            recordedFrames       = [],
            
            // how many frames have we recorded
            recordedFramesLength = 0;
            

          // Inner function 
					function drawVideoToCanvas () {

            // draw videoElement to canvas!
  					canvasElementCtx.drawImage(videoElement, 0, 0, videoWidth, videoWidth);
						
			recordedFrames.push(canvasElementCtx.getImageData( 0, 0, videoWidth, videoWidth));
            recordedFramesLength++;
            // save image data, push to ws at a time where it wont slow down the amount of frames we can record.
            // recordedFrames.push(canvasElementCtx.getImageData( 0, 0, videoWidth, videoWidth));
            // sockets.
            // send imageData uint8ClampedArray to WS socket server on every requestAnimationFrame.					
            // socket.emit('recordFrame', { image:true, buffer: canvasElementCtx.getImageData( 0, 0, videoWidth, videoWidth).data.buffer} );

            // Manually send first frame.
            // if (!firstFrameSent) {
            //   console.log('send first frame');
            //   firstFrameSent = true;
            //   firstFrameTimestamp = Date.now();
            //   socket.emit('recordFrame', { image:true, buffer: canvasElementCtx.getImageData( 0, 0, videoWidth, videoWidth).data.buffer} );              
            //   socket.on('recordFrameSuccess', function () {
            //     if (recordedFrames.length) {
            //       socket.emit('recordFrame', {image:true, buffer: recordedFrames[0].data.buffer });
            //       recordedFrames.shift();
            //     } else {
            //       socket.emit('stopRecording');
            //       console.log(((Date.now() - firstFrameTimestamp) / 1000) + ' is how long it took to send to the server 3 seconds worth of captured frames.');
            //     }
            //   })
            // } else {
            // // Let ws server tell us when we can send another
            //   recordedFramesLength++;
            //   recordedFrames.push(canvasElementCtx.getImageData( 0, 0, videoWidth, videoWidth));
            // }


            requestAnimationFrameId = requestAnimationFrame(drawVideoToCanvas);
          
          }

          
          videoElement.removeEventListener('canplay', recordCam);
                    
          videoElement.style.display='block';
          
          document.getElementById('recordSVG').style.display = 'block';


          turnRecordSVGOn();
          
          positionRecordSVG();

          window.positionRecordSVG = positionRecordSVG;
          window.addEventListener('resize', positionRecordSVG);


          setCanvasSize(videoElement.videoWidth, videoElement.videoHeight);


          var encoder = new Whammy.Video(60);

          var videoWidth = videoElement.videoWidth,
              videoHeight = videoElement.videoHeight;

          // START RECORDING
          requestAnimationFrameId = requestAnimationFrame(drawVideoToCanvas);

          
          setTimeout(function () {
  
            console.log((Math.round(recordedFramesLength / (SET_TIMEOUT_RECORDING / 1000))) + ' frames recorded per second.');

            

            cancelAnimationFrame(requestAnimationFrameId);
            
            // var beforeTime = Date.now();
             
            // frame = canvasElement.getContext('2d').getImageData(0,0,canvasElement.width,canvasElement.height).data
            // socket.emit('recordFrame', {image: true, buffer: frame.buffer});

            // console.log(((Date.now() - beforeTime) / 1000) + ' time elapsed.');
            for (var i = 0; i < recordedFrames.length; i++) {
              console.log('Processing frame: ' + i);
              // socket.emit('recordFrame', { image:true, buffer: recordedFrames[i].data.buffer} );
              canvasElement.getContext('2d').putImageData(recordedFrames[i], 0, 0);
              canvasElement.toDataURL('image/webp');
              encoder.add(canvasElement.toDataURL('image/webp'));
            }
                        
            OUTPUT = URL.createObjectURL(encoder.compile());
            // console.log('Video saved!');
          
            // socket.emit('stopRecording');
					
          }, SET_TIMEOUT_RECORDING);


				}

		    function getNumberFromString (str) {
		      return +(str.replace(/[^0-9\.\-]+/g, ''));
		    };
				
				function getTranslate (element) {

					var transform    = element.style.transform,
							hasTranslate = transform && transform.indexOf('translate') !== -1,
							translateArray;

					if (hasTranslate) {

						translateArray = transform.split(',');
						
						return {
							'left': getNumberFromString(translateArray[0]),
							'top' : getNumberFromString(translateArray[1])
						};
					
					}

					return {
						'left': 0,
						'top' : 0
					};
				
				}

				function turnRecordSVGOff () {
					
					var recordSVGStyle = document.getElementById('recordSVG').style;

					recordSVGStyle.opacity = 0.4;
					recordSVGStyle.fill    = 'red';
				
				}

				function turnRecordSVGOn () {

					var recordSVGStyle = document.getElementById('recordSVG').style;

					recordSVGStyle.opacity = 1;
					recordSVGStyle.fill    = 'url(#recordSVGGradient)';
					
				}

			  function positionRecordSVG () {

			    var MIN_DIST_FROM_EDGE = 20,
			    		recordSVG 				 = document.getElementById('recordSVG'),
			        currentTransform   = getTranslate(recordSVG),
			        videoElementRect   = videoElement.getBoundingClientRect(),
			        recordSVGRect      = document.getElementById('recordSVG').getBoundingClientRect(),
			        left						   = currentTransform.left   + videoElementRect.left   - recordSVGRect.left   + MIN_DIST_FROM_EDGE,
			        top 						   = currentTransform.top + videoElementRect.bottom - recordSVGRect.bottom - MIN_DIST_FROM_EDGE;

			    recordSVG.style.transform = 'translate('+ left +'px,'+ top +'px)';

			  }

			  window.createProcessForEncoding = createProcessForEncoding;

        function createProcessForEncoding () {
          
          var gui = require('nw.gui');
          
          // Eventually this could be invisible???
          var winProcess = gui.Window.open('process.html', {
            'new-instance': true,
            'width': 900,
            'height': 600,
            'inject-js-end': 'process.js'
          });



          var script = document.createElement('script');
    
          script.src = 'http://localhost:8765/socket.io/socket.io.js';
    
          script.onload = function(){

            console.log('Socket library loaded.');

            socket = io('http://localhost:8765');
        
          };

          document.head.appendChild(script);
          
        }

			    
		    function init () {

					createProcessForEncoding()
			
					videoElement = document.querySelector('video');

					window.videoElement = videoElement;

					navigator.webkitGetUserMedia(
						MEDIA_SETTINGS, 
						captureMedia, 
						onGetUserMediaError
					);	

				}

				document.addEventListener("DOMContentLoaded", init);

			}());

		</script>
	
	</head>
	

	<body>
		<!-- 				ICONS 													https://github.com/iconic/open-iconic/tree/master/svg --> 
		<div id="panel">
			<ul>
				<li id='reload'>
					<svg fill="#bbb" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 8 8">
	  				<path d="M4 0c-2.2 0-4 1.8-4 4s1.8 4 4 4c1.1 0 2.12-.43 2.84-1.16l-.72-.72c-.54.54-1.29.88-2.13.88-1.66 0-3-1.34-3-3s1.34-3 3-3c.83 0 1.55.36 2.09.91l-1.09 1.09h3v-3l-1.19 1.19c-.72-.72-1.71-1.19-2.81-1.19z" />
					</svg>
				</li>
				<li id='tools'>
					<svg fill="#bbb" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 8 8">
	  				<path d="M5.5 0c-1.38 0-2.5 1.12-2.5 2.5 0 .32.08.62.19.91l-2.91 2.88c-.39.39-.39 1.05 0 1.44.2.2.46.28.72.28.26 0 .52-.09.72-.28l2.88-2.91c.28.11.58.19.91.19 1.38 0 2.5-1.12 2.5-2.5 0-.16 0-.32-.03-.47l-.97.97h-2v-2l.97-.97c-.15-.03-.31-.03-.47-.03zm-4.5 6.5c.28 0 .5.22.5.5s-.22.5-.5.5-.5-.22-.5-.5.22-.5.5-.5z" />
					</svg>
				</li>
			</ul>
		</div>

		<!--- BOTTOM PANEL -->
		<div id="panel2">
			<ul>
				<li id='record'>
					<svg height="40" width="40">
						<defs>
				        <radialGradient id="recordSVGGradient">
				            <stop offset="5%" stop-color="#FF704D"/>
				            <stop offset="95%" stop-color="red"/>
				        </radialGradient>
				    </defs>
					  <circle cx="20" cy="20" r="20" fill="url(#recordSVGGradient)" />
					</svg>
				</li>
			</ul>
		</div>

		<!--  VIDEO -->
		<video style='display:none;' id='video' autoplay></video>
		
		<!-- RECORD ICON -->
		<svg style='display:none;' id='recordSVG' height="80" width="80">
			<defs>
	        <radialGradient id="recordSVGGradient">
	            <stop offset="5%" stop-color="#FF704D"/>
	            <stop offset="95%" stop-color="red"/>
	        </radialGradient>
	    </defs>
		  <circle cx="40" cy="40" r="40" fill="url(#recordSVGGradient)" />
		</svg>


	</body>


</html>